
## Supporting User ID in graphIR
### 1. Added `user_id` field to GraphIR elements
- Added `user_id: Optional[str] = None` to `TensorSpec`, `ScalarSpec`, and `OpNode`
- Updated `GraphIR.__init__` to accept `user_id`
- Propagated `user_id` from GraphIR to tensors, scalars, and operations when created

### 2. Added `combine` classmethod to GraphIR
- Merges multiple user GraphIRs into one
- Preserves `user_id` on all elements
- Resets loop metadata to `None` as requested
- Ensures unique op IDs by prefixing with `user_id` when available

### 3. Updated text serialization
- `to_text()` includes `@user(id=...)` in the graph header when `user_id` is set
- `from_text()` parses `@user(id=...)` (backward compatible with old format)

### 4. Updated two-jobs example
- `model.py` generates two separate GraphIR files (`job1_graph_ir.txt` and `job2_graph_ir.txt`), one per user
- Each graph uses `user_id="user1"` and `user_id="user2"` respectively
- `spatial_mapping.py` loads both files and combines them using `GraphIR.combine()`
- Backward compatible: still supports the old single-file format

### 5. Updated execute script
- Simplified to use a single pair of N1 and N2 values for testing


## Create Abstract Evaluator Interface

Added a generalized evaluation interface and bridged it to existing cycle-based evaluation methods.

### 1. Created new interface (`mapping_evaluator.py`)
- `MappingEvaluator`: Abstract base class with:
  - `evaluate_node(node, graph) -> float`: Evaluate SearchNode during A* search
  - `evaluate_result(result, graph) -> float`: Evaluate complete MappingResult
  - `is_better(cost1, cost2) -> bool`: Compare costs (default: lower is better)
- `CycleBasedEvaluator`: Concrete implementation that bridges to existing methods:
  - Uses `SolutionEvaluator` when available (AStarSpatialMapper compatibility)
  - Uses `SubgraphEvaluator` when `use_subgraph_eval=True`
  - Falls back to simple cost estimate
  - Handles both new-style (`node.groups`) and old-style (`node.operators`) SearchNodes

### 2. Updated mappers to use the evaluator
- NewAStarMapper:
  - Added `evaluator` parameter to `__init__`
  - Replaced `_estimate_cost()` calls with `evaluator.evaluate_node()`
  - Updated cost comparisons to use `evaluator.is_better()`
  - Kept `_estimate_cost()` as deprecated wrapper for backward compatibility
- GridSpatialMapper:
  - Added `evaluator` parameter to `__init__`
  - Updated cost comparisons to use `evaluator.evaluate_result()` and `evaluator.is_better()`
- IterativeSpatialMapper:
  - Added `evaluator` parameter to `__init__`
  - Updated cost comparisons to use `evaluator.is_better()`
  - Fixed `to_absolute()` calls (removed incorrect argument)

## Adding testing fairness based policy `FairnessThenCycleEvaluator`

Created `FairnessThenCycleEvaluator` that implements lexicographic comparison: fairness first, then cycles.

### Features

1. Primary metric: fairness — higher fairness always wins (lower fairness_cost wins)
2. Secondary metric: cycles — when fairness scores are equal, lower cycle cost wins
3. Encoding: both metrics encoded in a single float value
   - `cost = fairness_cost * 1e12 + normalized_cycle_cost`
   - Ensures fairness dominates comparison
4. Comparison logic: `is_better()` compares fairness first with a threshold, then cycles if fairness is equal

### Implementation details

- `evaluate_node()`: Evaluates both fairness and cycle costs, encodes them
- `evaluate_result()`: Same for MappingResult
- `is_better()`: Lexicographic comparison with floating-point precision handling
- Helper methods: `get_fairness_cost()` and `get_cycle_cost()` for debugging

## Two jobs example

### 1024, 1024
![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_1024x1024_50000iters.png)

### 2048, 2048
![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_2048x2048_50000iters.png)

### 4096, 4096
![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_4096x4096_50000iters.png)

### 8192, 8192
![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_8192x8192_50000iters.png)


|1024,2048 |2048,1024 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_1024x2048_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_2048x1024_50000iters.png) |



|1024,4096 |4096,1024 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_1024x4096_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_4096x1024_50000iters.png) |



|1024,8192 |8192,1024 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_1024x8192_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_8192x1024_50000iters.png) |



xxx

|2048,4096 |4096,2048 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_2048x4096_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_4096x2048_50000iters.png) |


|2048,8192 |8192,2048 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_2048x8192_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_8192x4096_50000iters.png) |


|4096,8192 |8192,4096 |
|--|--|
| ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_4096x8192_50000iters.png) | ![enter image description here](https://raw.githubusercontent.com/happyandslow/playground/refs/heads/main/research/notes/figures/12-29-25/spatial_mapping_figures/spatial_mapping_result_map_8192x2048_50000iters.png) |



> Written with [StackEdit](https://stackedit.io/).



<!--stackedit_data:
eyJoaXN0b3J5IjpbMTI5NDQxNDE2LDUzNDU5MTcyXX0=
-->
