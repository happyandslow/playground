


### QKV fusion 
- Merging local Xq, Xk, Xv
- allReduce + broadcast along y axis
- 3 * dim_p_pe * bsz
<img src="figures/2-9-26/qkv-fusion.png" width="90%" />

### Scoring 
-  score = Xq * K
- [1, dim_p_pe] * [dim_p_pe, seq_len_local]
- allReduce + broadcast along x axis 

Compute score locally at PE

<!-- <figure> -->
<img src="figures/2-9-26/score-compute.png" width="90%" />
<!-- <figcaption>Your caption text here</figcaption>
</figure> -->

Scoring steps globally

<img src="figures/2-9-26/score-1.png" width="90%" />

<img src="figures/2-9-26/score-2.png" width="90%" />


<!-- <figure> -->
<img src="figures/2-9-26/score-3.png" width="90%" />
<!-- <figcaption>Your caption text here</figcaption>
</figure> -->


### Softmax
- AllReduce/broadcast along y axis
  
<img src="figures/2-9-26/softmax.png" width="90%" />


### Output
- output =  V * score
- [dim_p_pe, seq_len_local] * [1, dim_p_pe]
- AllReduce/broadcast along y axis

Compute PE -local output
<img src="figures/2-9-26/output-compute.png" width="90%" />

Output step globally

<img src="figures/2-9-26/output-1.png" width="90%" />

<img src="figures/2-9-26/output-2.png" width="90%" />

<img src="figures/2-9-26/output-3.png" width="890%" />

Written with [StackEdit](https://stackedit.io/).
> 
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTkyODM1NTA0NiwyMDU5MjU3OTYxLC0xMT
M0MTE3MjUzLDczMDk5ODExNl19
-->